{% extends 'base.html' %}

{% block title %}Processing – PubTrends{% endblock %}
{% block meta_description %}Running your PubTrends analysis and preparing visualizations…{% endblock %}
{% set active_page = None %}

{% block content %}
<section class="pt-hero p-5 mb-4">
    <div class="row align-items-center gy-3">
        <div class="col-lg-10">
            <h1 class="h5 mb-2">Processing…</h1>
            <p class="mb-0 pt-muted">Please wait while we analyze
                <strong>{{ query }}</strong> at <strong>{{ source }}</strong> ({{ limit }} {{ sort }}).</p>
        </div>
        <div class="col-lg-2 text-lg-end">
            <button class="btn btn-outline-secondary" type="button" onclick="cancel()">
                <i class="bi bi-x-lg"></i> Cancel
            </button>
        </div>
    </div>
    <p>
    <div id="progress" class="progress" aria-live="polite">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <span class="progress-bar-label" aria-live="polite">0%</span>
        </div>
    </div>
    <div class="h6 mt-3" id="status">Waiting for content…</div>
    <pre class="mt-3" id="log"></pre>
    </p>
</section>

{% endblock %}

{% block scripts_extra %}
<script>
    "use strict";

    const TIMEOUT = 5000; // 5 second
    const MAX_RETRIES = 30;
    let retries = 0;
    let cancelled = false;

    function check_status() {
        if (cancelled) {
            return;
        }
        const $status = $('#status');
        const $progress = $('#progress');
        const $log = $('#log');
        // Show a manual link to go back to the main page
        const back = `<br>Go back to <a class="grey" href="/">the main page</a>.`
        // Don't modify the status call, since we use it in tests
        $.ajax("/status/{{ jobid }}", {
            dataType: "json",
            success: function (response) {
                if (response.state === 'FAILURE') {
                    const errorMsg = `<h2>Error</h2><span class="error-message"> ${response.message} </span>`;
                    if (response.search_error) {
                        $status.html(errorMsg + back);
                    } else {
                        $status.html(errorMsg + `<br>We're working on it. Please check back soon.` + back);
                    }
                    $status.show();
                    $progress.hide();
                    $log.hide();
                } else if (response.state === 'SUCCESS') {
                    const href = response.redirect;
                    $progress.hide();
                    $log.hide();
                    // Show a manual link in case automatic redirect is blocked or fails
                    $status.html(
                        `Analysis complete. If you are not redirected automatically, open the <a class="grey" href="${href}">the results</a>.`
                    ).show();
                    window.location.replace(href);
                } else if (response.state !== undefined) {
                    if (response.progress !== undefined) {
                        $('.progress-bar').css('width', response.progress + '%').attr('aria-valuenow', response.progress);
                        $('.progress-bar-label').text(response.progress + '%');
                        $progress.show();
                    } else {
                        $progress.hide();
                    }
                    if (response.message !== undefined) {
                        $status.html(response.message + back);
                        $status.show();
                    } else {
                        $status.hide();
                    }
                    if (response.log !== undefined) {
                        $log.html(response.log);
                        $log.show();
                    } else {
                        $log.hide();
                    }
                    if (response.state !== 'REVOKED') {
                        setTimeout(check_status, TIMEOUT);
                    }
                } else {
                    retries += 1;
                    if (retries > MAX_RETRIES) {
                        $progress.hide();
                        $log.hide();
                        $status.html("<h2>Error</h2>Failed to fetch results.<br>We're working on it. Please check back soon." + back);
                        $status.show();
                    } else {
                        setTimeout(check_status, TIMEOUT);
                    }
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $progress.hide();
                $log.hide();
                if (textStatus === 'timeout') {
                    $status.html("<h2>Server is not responding</h2>We're working on it. Please check back soon." + back);
                } else {
                    $status.html("<h2>Error</h2>" + errorThrown + " We're working on it. Please check back soon." + back);
                }
                $status.show();
            },
            timeout: TIMEOUT * MAX_RETRIES
        });
    }

    function cancel() {
        const $status = $('#status');
        const $log = $('#log');
        const $progress = $('#progress');
        // Show a manual link in case automatic redirect is blocked or fails
        const redirect = `<br>If you are not redirected automatically, go back to <a class="grey" href="/">the main page</a>.`
        $.ajax("/cancel/{{ jobid }}", {
            method: "POST",
            dataType: "json",
            success: function (response) {
                if (response.state === 'CANCELLED') {
                    $progress.hide();
                    $log.hide();
                    $status.html(response.message + redirect);
                    $status.show();
                    setTimeout(function () {
                        window.location.replace('/');
                    }, TIMEOUT);
                } else if (response.state === 'FAILURE') {
                    $progress.hide();
                    $log.hide();
                    const errorMsg = `<h2>Error</h2><span class="error-message"> ${response.message} </span>`;
                    if (response.search_error) {
                        $status.html(errorMsg + redirect);
                    } else {
                        $status.html(errorMsg + `<br>We're working on it. Please check back soon.` + redirect);
                    }
                    $status.show();
                    setTimeout(function () {
                        window.location.replace('/');
                    }, TIMEOUT);
                }
            }
        });
        cancelled = true;
    }

    document.addEventListener('DOMContentLoaded', function () {
        check_status();
    });
</script>
{% endblock %}
