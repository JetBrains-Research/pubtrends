{% extends 'base.html' %}

{% block title %}Processing – PubTrends{% endblock %}
{% block meta_description %}Running your PubTrends analysis and preparing visualizations…{% endblock %}
{% set active_page = None %}

{% block content %}
<section class="pt-hero p-5 mb-4">
    <div class="row align-items-center gy-3">
        <div class="col-lg-10">
            <h1 class="h5 mb-2">Processing…</h1>
            <p class="mb-0 pt-muted">Please wait while we analyze
                <strong>{{ query }}</strong> at <strong>{{ source }}</strong> ({{ limit }} {{ sort }}).</p>
        </div>
        <div class="col-lg-2 text-lg-end">
            <button class="btn btn-outline-secondary" type="button" onclick="cancel()">
                <i class="bi bi-x-lg"></i> Cancel
            </button>
        </div>
    </div>
    <p>
    <div id="progress" class="progress" aria-live="polite">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <span class="progress-bar-label" aria-live="polite">0%</span>
        </div>
    </div>
    <div class="h6 mt-3 ms-3" id="status">Waiting for content…</div>
    <pre class="ms-3 mt-3" id="log"></pre>
    </p>
</section>

{% endblock %}

{% block scripts_extra %}
<script>
    "use strict";

    // Confirm and cancel when the user tries to leave the page
    window.onunload = function () {
        if (confirm('Leave the page? Task will be cancelled.')) {
            cancel();
        }
    };

    const TIMEOUT = 1000; // 1 second
    const MAX_RETRIES = 120; // 2 minutes total
    let retries = 0;
    let cancelled = false;

    function check_status() {
        if (cancelled) {
            return;
        }
        const $status = $('#status');
        const $progress = $('#progress');
        const $log = $('#log');
        $.ajax("{{ url_for('.status', jobid=jobid) }}", {
            dataType: "json",
            success: function (response) {
                if (response.state === 'FAILURE') {
                    const errorMsg = `<h2>Error</h2><span class="error-message"> ${response.message} </span>`;
                    if (response.search_error) {
                        $status.html(errorMsg);
                    } else {
                        $status.html(errorMsg + `<br>We're working on it. Please check back soon.`);
                    }
                    $status.show();
                    $progress.hide();
                    $log.html(response.log);
                } else if (response.state === 'SUCCESS') {
                    // Disable formatter for the next section because of injections.
                    // Enable formatter control in File > Settings > Editor > Code Style
                    // @formatter:off
                    // Join arg-value pairs for URL
                    var args = {{ redirect_args | safe }};
                    // @formatter:on

                    const args_list = [];
                    for (const key in args) {
                        args_list.push(`${key}=${args[key]}`);
                    }

                    // Build href for given redirect page and args
                    const href = `/{{ redirect_page }}?${args_list.join('&')}`;
                    // Show a manual link in case automatic redirect is blocked or fails
                    $progress.hide();
                    $log.hide();
                    $status.html(
                        `Analysis complete. If you are not redirected automatically, open the results:
                         <a class="btn btn-primary btn-sm ms-2" href="${href}">Open results</a>
                         <div class="small mt-2">Direct link: <a class="grey" href="${href}">${href}</a></div>`
                    ).show();
                    window.location.replace(href);
                } else if (response.state !== undefined) {
                    if (response.progress !== undefined) {
                        $('.progress-bar').css('width', response.progress + '%').attr('aria-valuenow', response.progress);
                        $('.progress-bar-label').text(response.progress + '%');
                        $progress.show();
                    } else {
                        $progress.hide();
                    }
                    if (response.message !== undefined) {
                        $status.html(response.message);
                        $status.show();
                    } else {
                        $status.hide();
                    }
                    if (response.log !== undefined) {
                        $log.html(response.log);
                        $log.show();
                    } else {
                        $log.hide();
                    }
                    if (response.state !== 'REVOKED') {
                        setTimeout(check_status, TIMEOUT);
                    }
                } else {
                    retries += 1;
                    if (retries > MAX_RETRIES) {
                        $progress.hide();
                        $status.html("<h2>Error</h2>Failed to fetch results.<br>We're working on it. Please check back soon.");
                        $status.show();
                    } else {
                        setTimeout(check_status, TIMEOUT);
                    }
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $progress.hide();
                $log.hide();
                if (textStatus === 'timeout') {
                    $status.html("<h2>Server is not responding</h2>We're working on it. Please check back soon.");
                } else {
                    $status.html("<h2>Error</h2>" + errorThrown + " We're working on it. Please check back soon.");
                }
                $status.show();
            },
            timeout: TIMEOUT * MAX_RETRIES
        });
    }

    function cancel() {
        const $status = $('#status');
        const $log = $('#log');
        const $progress = $('#progress');
        $.ajax("{{ url_for('.cancel', jobid=jobid) }}", {
            dataType: "json",
            success: function (response) {
                if (response.state === 'CANCELLED') {
                    $progress.hide();
                    $log.hide();
                    $status.html(response.message);
                    $status.show();
                    setTimeout(function () {
                        window.location.replace('/');
                    }, TIMEOUT);
                } else if (response.state === 'FAILURE') {
                    $progress.hide();
                    $log.hide();
                    const errorMsg = `<h2>Error</h2><span class="error-message"> ${response.message} </span>`;
                    if (response.search_error) {
                        $status.html(errorMsg);
                    } else {
                        $status.html(errorMsg + `<br>We're working on it. Please check back soon.`);
                    }
                    $status.show();
                    setTimeout(function () {
                        window.location.replace('/');
                    }, TIMEOUT);
                }
            }
        });
        cancelled = true;
    }

    document.addEventListener('DOMContentLoaded', function () {
        check_status();
    });
</script>
{% endblock %}
