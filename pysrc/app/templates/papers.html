{% extends 'base.html' %}
{% block title %}{{ query }} at {{ source }} {{ limit }} {{ sort }}{{ ' ' + search_string if search_string }} - PubTrends{% endblock %}
{% set active_page = None %}

{% block styles_extra %}
    <!-- Keep DataTables using Bootstrap 4 skin to avoid regressions -->
    <link href="https://cdn.datatables.net/2.3.3/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="{{ url_for('static', filename='feedback.css') }}?v=1">
{% endblock %}

{% block scripts_head %}
    <!-- DataTables with search (deferred by base) -->
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/g/mark.js(jquery.mark.min.js)"></script>
    <script src="https://cdn.datatables.net/plug-ins/2.3.3/features/mark.js/datatables.mark.js"></script>

    <!-- App scripts -->
    <script src="{{ url_for('static', filename='text_utils.js') }}"></script>
    <script src="{{ url_for('static', filename='feedback.js') }}"></script>
    <script src="{{ url_for('static', filename='notify.js') }}"></script>
    <script src="{{ url_for('static', filename='papers.js') }}"></script>
{% endblock %}

{% block content %}
    <!-- Compact page header aligned with result.html -->
    <section class="pt-hero py-3 px-3 px-md-4 mb-3">
        <div class="row align-items-center gy-2">
            <div class="col-lg-12 d-flex justify-content-between align-items-center">
                <div>
                    <ol class="breadcrumb bg-transparent mb-1 search-query">
                        <li class="breadcrumb-item">{{ source }}</li>
                        <li class="breadcrumb-item">
                            <a href="javascript:void(0);" class="link" onclick="result();"><strong>{{ query }}</strong></a>
                        </li>
                        <li class="breadcrumb-item">{{ limit }} {{ sort }}</li>
                        {% if search_string %}
                        <li class="breadcrumb-item">{{ search_string }}</li>
                        {% endif %}
                    </ol>
                    <p class="pt-muted small mb-0">View the full list of papers and export results.</p>
                </div>
                <div>
                    <a id="to-result" href="javascript:void(0);" class="btn btn-outline-secondary" onclick="result();">
                        Back to results
                    </a>
                </div>
            </div>
        </div>
    </section>

    <div class="row">
        <main class="col-12" role="main">
            <div class="card pt-card border-light">
                <div class="card-title">
                    <h1 class="card-header">Papers</h1>
                </div>
                <div class="card-body">
                    <!-- Make the table use all available horizontal space and behave well on narrow screens -->
                    <div class="table-responsive">
                    <table id="papers" class="table table-sm table-bordered table-striped w-100" width="100%" aria-describedby="papers table">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Title</th>
                            <th scope="col">Authors</th>
                            <th scope="col">Journal</th>
                            <th scope="col">Year</th>
                            <th scope="col">Id</th>
                            <th scope="col">Doi</th>
                            <th scope="col">Cited</th>
                            <th scope="col">Topic</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for id, title, authors, url, journal, year, total, doi, topic in papers %}
                        <tr>
                            <th scope="row">{{ loop.index }}</th>
                            <td>{{ title }}</td>
                            <td>{{ authors }}</td>
                            <td>{{ journal }}</td>
                            <td>{{ year }}</td>
                            <td><a class="link" href="{{ url }}" title="Open in {{ source }}">{{ id }}</a></td>
                            <td>
                                {% if doi != "" %}
                                <a class="link" href="https://doi.org/{{ doi }}">{{ doi }}</a>
                                {% endif %}
                            </td>
                            <td>{{ total }}</td>
                            <td>{{ topic }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    </div>
                    <button type="button" class="btn btn-primary mt-3"
                            onclick="export_to_csv('papers', window.papers_table, '{{ export_name }}');">
                        Export to CSV
                    </button>
                </div>
            </div>
            <div id="feedback-papers-form" class="mt-3"></div>
        </main>
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
    "use strict";
    function result() {
        const url = '/result?query=' + normalize('{{ query }}');
        const jobid = new URL(window.location).searchParams.get('jobid');
        window.open(url + '&jobid=' + jobid, '_blank');
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Mark search by default in datatables
        if ($ && $.fn && $.fn.dataTable) {
            $.extend(true, $.fn.dataTable.defaults, { mark: true });
        }
        // Initialize DataTable and ensure it uses full width
        if ($ && $.fn && $.fn.DataTable) {
            window.papers_table = $('#papers').DataTable({
                autoWidth: false
            });
            // Recalculate column widths now that the table is visible and has 100% width
            window.papers_table.columns.adjust();
        }
        // Feedback widget (guard)
        if (typeof createClickableFeedBackForm === 'function') {
            createClickableFeedBackForm('feedback-papers-form', 'feedback-papers');
        }
    });
</script>
{% endblock %}