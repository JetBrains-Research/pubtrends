{% extends 'base.html' %}
{% block title %}{{ title }} - PubTrends{% endblock %}
{% block meta_description %}Paper information {{ title }}.{% endblock %}
{% set active_page = None %}
{% block styles_extra %}
    <!-- Keep DataTables using Bootstrap 4 skin to avoid regressions in complex tables -->
    <link href="https://cdn.datatables.net/2.3.3/css/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="{{ url_for('static', filename='feedback.css') }}?v=1">
{% endblock %}
{% block scripts_head %}
    <!-- Vendor libs required before inline scripts (deferred by base) -->
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-3.6.3.min.js"></script>
    <script src="https://cdn.bokeh.org/bokeh/release/bokeh-widgets-3.6.3.min.js"></script>
    <!-- DataTables with search -->
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.3/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/g/mark.js(jquery.mark.min.js)"></script>
    <script src="https://cdn.datatables.net/plug-ins/2.3.3/features/mark.js/datatables.mark.js"></script>
    <!-- App scripts -->
    <script src="{{ url_for('static', filename='text_utils.js') }}"></script>
    <script src="{{ url_for('static', filename='feedback.js') }}"></script>
    <script src="{{ url_for('static', filename='notify.js') }}"></script>
    <script src="{{ url_for('static', filename='navigate.js') }}?v=1"></script>
{% endblock %}

{% block content %}
    <!-- Compact page header -->
    <section class="pt-hero py-3 px-3 px-md-4 mb-3">
        <div class="row align-items-center gy-2">
            <div class="col-lg-12 d-flex justify-content-between align-items-center">
                <div>
                    <ol class="breadcrumb bg-transparent mb-1 search-query">
                        <li class="breadcrumb-item">{{ source }}</li>
                        <li class="breadcrumb-item"><strong>{{ query }}</strong></li>
                        <li class="breadcrumb-item">{{ limit }} {{ sort }}</li>
                    </ol>
                    <p class="pt-muted small mb-0">Explore selected paper, its network and related works.</p>
                </div>
                <div>
                    <a id="result" href="javascript:void(0);" class="btn btn-outline-secondary" onclick="result();">
                        Explore all papers
                    </a>
                </div>
            </div>
        </div>
    </section>

    <div class="row g-3">
        <!-- Mobile quick navigation (top) -->
        <div class="d-lg-none">
            <div class="sticky-top bg-white border-bottom py-2 px-2" role="navigation">
                <div class="nav nav-pills flex-nowrap overflow-auto" id="onpage-mobile">
                    <a class="nav-link py-1 px-2 me-1 grey" href="#paper">Paper</a>
                    {% if papers_graph is defined %}
                    <a class="nav-link py-1 px-2 me-1 grey" href="#network">Network</a>
                    {% endif %}
                    {% if similar_papers is defined %}
                    <a class="nav-link py-1 px-2 me-1 grey" href="#similar">Similar Papers</a>
                    {% endif %}
                    {% if prior_papers is defined %}
                    <a class="nav-link py-1 px-2 me-1 grey" href="#prior">Prior Papers</a>
                    {% endif %}
                    {% if derivative_papers is defined %}
                    <a class="nav-link py-1 px-2 me-1 grey" href="#derivative">Derivative Papers</a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sticky sidebar (left) -->
        <nav class="d-none d-lg-block col-lg-2 col-xl-2">
            <div id="sidebar" class="position-sticky" style="top: 1rem">
                <div class="toc pt-card p-2" style="padding-bottom: 0;">
                    <div style="max-height: calc(100vh - 6rem - 1rem); overflow-y: auto; overflow-x: hidden; padding-bottom: 0.5rem;">
                        <ul class="nav flex-column" id="onpage-desktop">
                            <li class="nav-item d-flex align-items-center">
                                <img class="nav-icon me-2" alt="" src="{{ url_for('static', filename='home.svg') }}"/>
                                <a class="nav-link px-0 py-1" href="#paper">Paper</a>
                            </li>
                            {% if papers_graph is defined %}
                            <li class="nav-item d-flex align-items-center">
                                <img class="nav-icon me-2" alt="" src="{{ url_for('static', filename='globe.svg') }}"/>
                                <a class="nav-link px-0 py-1" href="#network">Network</a>
                            </li>
                            {% endif %}
                            {% if similar_papers is defined %}
                            <li class="nav-item d-flex align-items-center">
                                <img class="nav-icon me-2" alt="" src="{{ url_for('static', filename='pause.svg') }}"/>
                                <a class="nav-link px-0 py-1" href="#similar">Similar Papers</a>
                            </li>
                            {% endif %}
                            {% if prior_papers is defined %}
                            <li class="nav-item d-flex align-items-center">
                                <img class="nav-icon me-2" alt="" src="{{ url_for('static', filename='rewind.svg') }}"/>
                                <a class="nav-link px-0 py-1" href="#prior">Prior Papers</a>
                            </li>
                            {% endif %}
                            {% if derivative_papers is defined %}
                            <li class="nav-item d-flex align-items-center">
                                <img class="nav-icon me-2" alt="" src="{{ url_for('static', filename='fast-forward.svg') }}"/>
                                <a class="nav-link px-0 py-1" href="#derivative">Derivative Papers</a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main content (expanded to fill horizontal space) -->
        <main class="col-lg-10 col-xl-10" role="main">
            <div id="paper" class="card mt-3">
                <div class="card-title">
                    <h1 class="card-header">Paper</h1>
                </div>
                <div class="card-body">
                    <div>
                        <h2 class="paper-title">{{ title }}</h2>
                        <em>{{ authors }}</em>
                        <!-- Generate info about publication year and journal-->
                        {% if journal != "" %}
                            <br>
                            <b>Journal:</b> {{ journal }}
                        {% endif %}
                        {% if year != "None" %}
                            <br>
                            <b>Year:</b> {{ year }}
                        {% endif %}
                        {% if doi != "" %}
                            <br>
                            <b>Doi:</b> <a class="link" href="https://doi.org/{{ doi }}">https://doi.org/{{ doi }}</a>
                        {% endif %}
                        <br>
                        <b>{{ source }}:</b> <a class="link" href="{{ url }}">{{ url }}</a>
                        {% if mesh != "" %}
                            <br>
                            <b>Mesh:</b> {{ mesh }}
                        {% endif %}
                        {% if keywords != "" %}
                            <br>
                            <b>Keywords:</b> {{ keywords }}
                        {% endif %}
                        <br>
                        <b>Topic</b>: {{ topic }}
                        <svg width="16" height="16">
                            <rect width="16" height="16" style="fill: {{ topics_palette[topic - 1] }}"/>
                        </svg>
                        <br>
                        <b>Topic tags</b>: {{ topic_tags }}

                        {% if abstract is defined %}
                            <h5 class="card-subtitle mt-3">Abstract</h5>
                            <p class="mt-2">{{ abstract }}</p>
                        {% endif %}
                    </div>
                    <h5 class="card-subtitle mt-3">Citations</h5>
                    <p class="mt-2">Number of citations per year for the paper.</p>
                    <div>
                        {% for script, div in citation_dynamics %}
                            {{ script|safe }}
                            {{ div|safe }}
                        {% endfor %}
                    </div>
                    <div class="mt-3" id="paper-feedback-paper-form"></div>
                </div>
            </div>

            {% if papers_graph is defined %}
                <div id="network" class="card mt-3">
                    <div class="card-title">
                        <h1 class="card-header">Network</h1>
                    </div>
                    <div class="card-body">
                        {% if n_papers <= max_graph_size %}
                            <strong>Papers similarity</strong>
                            <p>
                                The graph below shows papers similarity network. Similar papers are located closely.<br>
                                Edges represent co-citations, common references and citations between papers.<br>
                                Color represents topic, size - paper "importance" in the graph.
                            </p>
                            {% for script, div in papers_graph %}
                                {{ script|safe }}
                                {{ div|safe }}
                            {% endfor %}
                            <br>
                            <p>
                                Explore papers similarity in-depth in the interactive graph viewer.<br>
                                Filter papers by keywords and apply different coloring schemes.
                            </p>
                            <button type="button" class="btn btn-light" onclick="graph_callback();">
                                Explore
                            </button>
                        {% else %}
                            Too many papers to visualize graphs.
                        {% endif %}
                        <div class="mt-3" id="paper-feedback-network-form"></div>
                    </div>
                </div>
            {% endif %}

            {% if similar_papers is defined %}
                <div id="similar" class="card mt-3">
                    <div class="card-title">
                        <h1 class="card-header">Similar Papers</h1>
                    </div>
                    <div class="card-body">
                        <p>
                            This section represents papers, similar to the paper of interest.
                        </p>
                        <table id="similar_papers" class="table table-sm table-bordered table-striped">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Title</th>
                                <th scope="col">Year</th>
                                <th scope="col">Cited</th>
                                <th scope="col">Similarity</th>
                                <th scope="col">Topic</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for id, title, url, year, cited, similarity, topic in similar_papers %}
                                <tr>
                                    <th scope="row">{{ loop.index }}</th>
                                    <td>
                                        <a class="link" href="{{ url }}" title="Open in {{ source }}">
                                            {{ title }}
                                        </a>
                                    </td>
                                    <td>{{ year }}</td>
                                    <td>{{ cited }}</td>
                                    <td>{{ similarity }}</td>
                                    <td>{{ topic }}
                                        <svg width="16" height="16">
                                            <rect width="16" height="16" style="fill: {{ topics_palette[topic - 1] }}"/>
                                        </svg>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <div class="mt-3" id="paper-feedback-similar-form"></div>
                    </div>
                </div>
            {% endif %}

            {% if prior_papers is defined %}
                <div id="prior" class="card mt-3">
                    <div class="card-title">
                        <h1 class="card-header">Prior Papers</h1>
                    </div>
                    <div class="card-body">
                        <p>
                            This section represents most cited papers, cited by the paper of interest.
                        </p>
                        <table id="prior_papers" class="table table-sm table-bordered table-striped">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Title</th>
                                <th scope="col">Year</th>
                                <th scope="col">Cited</th>
                                <th scope="col">Topic</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for id, title, url, year, cited, topic in prior_papers %}
                                <tr>
                                    <th scope="row">{{ loop.index }}</th>
                                    <td>
                                        <a class="link" href="{{ url }}" title="Open in {{ source }}">
                                            {{ title }}
                                        </a>
                                    </td>
                                    <td>{{ year }}</td>
                                    <td>{{ cited }}</td>
                                    <td>{{ topic }}
                                        <svg width="16" height="16">
                                            <rect width="16" height="16" style="fill: {{ topics_palette[topic - 1] }}"/>
                                        </svg>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <div class="mt-3" id="paper-feedback-prior-form"></div>
                    </div>
                </div>
            {% endif %}

            {% if derivative_papers is defined %}
                <div id="derivative" class="card mt-3">
                    <div class="card-title">
                        <h1 class="card-header">Derivative Papers</h1>
                    </div>
                    <div class="card-body">
                        <p>
                            This section represents most cited papers, citing the paper of interest.
                        </p>
                        <table id="derivative_papers" class="table table-sm table-bordered table-striped">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Title</th>
                                <th scope="col">Year</th>
                                <th scope="col">Cited</th>
                                <th scope="col">Topic</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for id, title, url, year, cited, topic in derivative_papers %}
                                <tr>
                                    <th scope="row">{{ loop.index }}</th>
                                    <td>
                                        <a class="link" href="{{ url }}" title="Open in {{ source }}">
                                            {{ title }}
                                        </a>
                                    </td>
                                    <td>{{ year }}</td>
                                    <td>{{ cited }}</td>
                                    <td>{{ topic }}
                                        <svg width="16" height="16">
                                            <rect width="16" height="16" style="fill: {{ topics_palette[topic - 1] }}"/>
                                        </svg>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <div class="mt-3" id="paper-feedback-derivative-form"></div>
                    </div>
                </div>
            {% endif %}

            <div class="mt-3 ms-3" id="log">
                <a href="javascript:void(0);" class="btn btn-light" role="button" onclick="export_data();">Export</a>
            </div>
        </main>

        <!-- Back to top button (shared behavior in navigate.js) -->
        <button type="button" id="backToTop" class="btn btn-outline-secondary btn-sm back-to-top" aria-label="Back to top">
            <i class="bi bi-arrow-up"></i>
        </button>

        <!--Right spacer removed to allow main content to fill horizontal space-->
    </div>
{% endblock %}

{% block scripts_extra %}
<script>
    "use strict";
    function result() {
        const url = '/result?query=' + normalize('{{ query }}');
        const params = new URL(window.location);
        const jobid = params.searchParams.get('jobid');
        const pid = params.searchParams.get('id');
        window.open(url + '&jobid=' + jobid + '&id=' + pid, '_blank');
    }

    function graph_callback() {
        const url = '/graph?query=' + normalize('{{ query }}');
        const params = new URL(window.location);
        const jobid = params.searchParams.get('jobid');
        const pid = params.searchParams.get('id');
        window.open(url + '&id=' + pid + '&jobid=' + jobid, '_blank');
    }

    function export_data() {
        const jobid = new URL(window.location).searchParams.get('jobid');
        window.open('/export/' + jobid, '_blank');
    }

    $(document).ready(function () {
        // Mark search by default in datatables
        if ($ && $.fn && $.fn.dataTable) {
            $.extend(true, $.fn.dataTable.defaults, { mark: true });
        }
        // Setup datatables
        if ($('#prior_papers').length) {
            $('#prior_papers').DataTable();
        }
        if ($('#derivative_papers').length) {
            $('#derivative_papers').DataTable();
        }
        if ($('#similar_papers').length) {
            $('#similar_papers').DataTable();
        }

        // Configure jobid for feedback
        const jobid = new URL(window.location).searchParams.get('jobid');
        $('#feedback-jobid').val(jobid);

        // Create clickable feedback forms (guard if function exists)
        if (typeof createClickableFeedBackForm === 'function') {
            createClickableFeedBackForm("paper-feedback-paper-form", "paper-feedback-paper");
            createClickableFeedBackForm("paper-feedback-network-form", "paper-feedback-network");
            createClickableFeedBackForm("paper-feedback-similar-form", "paper-feedback-similar");
            createClickableFeedBackForm("paper-feedback-prior-form", "paper-feedback-prior");
            createClickableFeedBackForm("paper-feedback-derivative-form", "paper-feedback-derivative");
            createClickableFeedBackForm("paper-feedback-related-form", "paper-feedback-related");
        }
        // Shared navigation behavior (desktop scroll‑spy + back‑to‑top)
        if (window.PTNavigation && typeof window.PTNavigation.init === 'function') {
            window.PTNavigation.init({
                desktopNavId: 'onpage-desktop',
                backToTopId: 'backToTop'
            });
        }
    });
</script>
{% endblock %}