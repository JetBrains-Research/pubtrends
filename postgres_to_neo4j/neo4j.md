Neo4j integration
=================
This document contains brief instruction on configuring [Neo4j](https://neo4j.com/product/?ref=home-banner) database for Pubtrends project.

Configure Neo4j
---------------

* Export data from PostgreSQL to csv format

    ```
    psql postgres://user:password@host:5432/pubtrends -f export_twitter_to_csv.psql;

    ```

* Connect into Neo4j Docker container interactively 

    ```
    docker run --volume=/home/user/work/pubtrends:/pubtrends  \
        --volume=$HOME/neo4j/data:/data --volume=$HOME/neo4j/logs:/logs \
        -it neo4j:3.5 /bin/bash
    ```
    
* Launch batch import procedure (within Docker container)

    ```
    neo4j-admin import -ignore-missing-nodes=true --mode csv --multiline-fields \
        --nodes:PMPublication="/pubtrends/pmpublications_header.csv,/pubtrends/pmpublications.csv" \
        --relationships:PMReferenced="/pubtrends/pmcitations_header.csv,/pubtrends/pmcitations.csv"
    ```
  
* Launch Neo4j database as a service
    
    ```
    docker run --publish=7474:7474 --publish=7687:7687 \
        --volume=$HOME/neo4j/data:/data --volume=$HOME/neo4j/logs:/logs neo4j:3.5
    ```

* Open `localhost:7474` in web browser, default login/password are `neo4j/neo4j`.


Playground with Pubmed
----------------------

* Create index on `pmid`

    ```
    CREATE INDEX ON :PMPublication(pmid);
    ```

* Lookup publications by "DNA methylation clock" Entrez query 
    
```
WITH ['31493228', '31477683', '31470034', '31466396', '31466081', '31450859', '31443728', '31427190', '31426852', '31409373', '31398259', '31395791', '31387022', '31375479', '31330572', '31316102', '31297302', '31286441', '31235674', '31234328', '31179827', '31179760', '31156022', '31113906', '31092926', '31087518', '31072398', '31070469', '31068130', '31031806', '31019206', '31001624', '30976985', '30975202', '30888653', '30878026', '30873202', '30842553', '30833961', '30822165', '30814520', '30794318', '30793958', '30791227', '30765617', '30738172', '30721705', '30712319', '30704927', '30669120', '30666568', '30660189', '30638314', '30621723', '30587242', '30524474', '30537516', '30530921', '30482885', '30465968', '30427307', '30409196', '30397597', '30373515', '30370743', '30361985', '30350398', '30348905', '30345885', '30332397', '30326963', '30270726', '30241605', '30210566', '30185790', '30178254', '30178252', '30167451', '30157950', '30142075', '30140739', '30137208', '30130743', '30113688', '30075802', '30069000', '30048243', '30021623', '30016711', '29974462', '29897034', '29888306', '29796118', '29753700', '29746298', '29729018', '29718110', '29706161', '29692214', '29691382', '29676998', '29667924', '29643443', '29614968', '29610480', '29580070', '29555673', '29554203', '29529061', '29524919', '29452766', '29432558', '29374233', '29367468', '29353016', '29337038', '29321814', '29271864', '29258983', '29235933', '29225347', '29221677', '29197076', '29162648', '29144171', '29106308', '29081695', '28988914', '28960094', '28942711', '28932320', '28928877', '28889075', '28827677', '28733336', '28731985', '28731140', '28721811', '28691915', '28682785', '28637423', '28614626', '28613964', '28590035', '28503212', '28487473', '28470125', '28428831', '28423572', '28399939', '28380383', '28377537', '28373601', '28368004', '28364215', '28361883', '28351423', '28351383', '28303888', '28289478', '28289477', '28259012', '28249716', '28198702', '28115210', '28111986', '28098396', '28089957', '28065650', '28058257', '28058013', '27922611', '27889677', '27885421', '27883893', '27859855', '27855491', '27835646', '27826842', '27792016', '27771773', '27765932', '27760549', '27644593', '27739341', '27720826', '27717399', '27716309', '27712846', '27702440', '27690265', '27601674', '27511193', '27498152', '27479945', '27457926', '27385050', '27346616', '27300324', '27276709', '27274774', '27168458', '27105110', '27104983', '27075770', '27002152', '26951782', '26925173', '26885756', '26873744', '26861258', '26830004', '26734012', '26689571', '26684672', '26680699', '26678252', '26678051', '26673150', '26655927', '26594032', '26485162', '26411804', '26282238', '26253128', '26252151', '26251327', '26168277', '26105183', '26021168', '26000617', '25991677', '25971926', '25969563', '25964789', '25913071', '25831497', '25824446', '25688509', '25678027', '25662463', '25617346', '25569172', '25429045', '25423365', '25405464', '25375876', '25341512', '25315904', '25313752', '25313081', '25198253', '25175925', '24894042', '24884411', '24717494', '24636549', '24594986', '24531307', '24498074', '24413057', '24284824', '24228927', '24138928', '24103761', '23877850', '23649761', '23604474', '23319591', '23307192', '23217262', '23128602', '23003921', '22878891', '22847467', '22826347', '22805206', '22554448', '22495928', '22470559', '22470318', '22438023', '22348461', '22193177', '22080730', '22041901', '21811413', '21596611', '21536041', '21495873', '21317377', '21153620', '21139085', '20877475', '20711251', '20399247', '20134149', '20043880', '19861541', '19296127', '19031430', '18676844', '18483325', '18410448', '18396448', '18358604', '17672908', '17562333', '17030450', '17029560', '16999817', '16717091', '16683245', '16582617', '16314580', '15975143', '15941485', '15860628', '15790588', '15779908', '14577056', '11820819', '11032969', '1943146', '1722018', '2777259', '2857475'] AS pmids MATCH (p:PMPublication) WHERE p.pmid IN pmids LIMIT 20;
```

* Build full-text-search index for title and abstract records. **NOTE**: this is time and resources - consuming operation

    ```
    CALL db.index.fulltext.createNodeIndex("pmTitlesAndAbstracts",["PMPublication"],["title", "abstract"]);
    ```

* Inspect search results

    ```
    CALL db.index.fulltext.queryNodes("pmTitlesAndAbstracts", "methylation") YIELD node, score 
    RETURN node.title, node.abstract, score LIMIT 20;
    ```

* Compute amount of results
    ```
    CALL db.index.fulltext.queryNodes("pmTitlesAndAbstracts", "cancer") YIELD node RETURN count(*);
    ```

* Build search with sorting by number of citing papers.

    ```
    CALL db.index.fulltext.queryNodes("pmTitlesAndAbstracts", "'dna' AND 'methylation' AND 'clock'") YIELD node AS n
    MATCH ()-[r:PMReferenced]->(p:PMPublication) 
    WHERE p.pmid = n.pmid 
    WITH p, COUNT(r) AS cnt 
    RETURN p 
    ORDER BY cnt DESC 
    LIMIT 10000;
    ```
