<!DOCTYPE html>
<html>
<head>
    <title>PubTrends - Publication Analysis Service</title>
    <meta charset="utf-8">
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css"
          integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt"
          crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <script src="https://cdn.pydata.org/bokeh/release/bokeh-1.2.0.min.js"></script>
    <script src="https://cdn.pydata.org/bokeh/release/bokeh-widgets-1.2.0.min.js"></script>
    <link href="https://cdn.pydata.org/bokeh/release/bokeh-1.2.0.min.css"
          rel="stylesheet" type="text/css">
    <link href="https://cdn.pydata.org/bokeh/release/bokeh-widgets-1.2.0.min.css"
          rel="stylesheet" type="text/css">
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>
    <link href="https://cdn.datatables.net/1.10.20/css/dataTables.bootstrap4.min.css"
          rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
    <!--     <link rel="stylesheet" href="../static/style.css"/> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='result.css') }}">
    <!--    <link rel="stylesheet" href="../static/result.css"/>-->
    <script>
        "use strict";

        function papers_callback_impl(key, value) {
            // Query may contain double quotes, fix it.
            const query_fixed = '{{ query }}'.replace(/&#34;/g, '"');
            const url = '/papers?query=' + query_fixed + '&source={{source}}';
            // Decode jobid from URL
            const jobid = new URL(window.location).searchParams.get('jobid');
            var args = '';
            if (key != null) {
                args = '&' + key + '=' + value;
            }
            window.open(url + args + '&jobid=' + jobid, '_blank');
        }

        function papers_callback() {
            papers_callback_impl(null, null)
        }
        function papers_callback_component(comp) {
            papers_callback_impl('comp', comp)
        }
        function papers_callback_word(word) {
            papers_callback_impl('word', word)
        }
        function papers_callback_author(author) {
            papers_callback_impl('author', author)
        }
        function papers_callback_journal(journal) {
            papers_callback_impl('journal', journal)
        }
    /**
     * See for details
     * http://stackoverflow.com/questions/19689715/what-is-the-best-way-to-detect-retina-support-on-a-device-using-javascript
     */
    function isHighDensity() {
        return ((window.matchMedia &&
                (window.matchMedia('only screen and (min-resolution: 124dpi), only screen and (min-resolution: 1.3dppx), ' +
                    'only screen and (min-resolution: 48.8dpcm)').matches ||
                    window.matchMedia('only screen and (-webkit-min-device-pixel-ratio: 1.3), ' +
                        'only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and ' +
                        '(min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)').matches)) ||
                (window.devicePixelRatio && window.devicePixelRatio > 1.3));
    }

    function process_word_cloud(id, words) {
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext("2d");
        // Make canvas visible
        canvas.style.width = "220px";
        canvas.style.height = "360px";

        // Retina/HiDPI fix
        if (isHighDensity()) {
            canvas.width = 440;
            canvas.height = 720;
            ctx.scale(2, 2);
        } else {
            canvas.width = 220;
            canvas.height = 360;
        }

        const links = []; // Links information
        var hoverWord = ""; // Word which cursor points at
        ctx.textBaseline = "top"; // Makes left top point a start point for rendering text

        function addWord(word, x, y, size, vertical, color) {

            ctx.fillStyle = color;
            ctx.font = size.toString() + "px Arial Bold";

            var linkWidth = ctx.measureText(word).width,
                linkHeight = parseInt(ctx.font); // Get lineheight out of fontsize

            if (vertical) {
                ctx.save();
                ctx.translate(x, y + linkWidth);
                ctx.rotate(-Math.PI/2);
                ctx.fillText(word, 0, 0);
                ctx.restore();
            } else {
                ctx.fillText(word, x, y);
            }

            // Add mouse listeners
            canvas.addEventListener("mousemove", onMouseMove, false);
            canvas.addEventListener("click", onClick, false);

            // Add link params to array for hover processing
            if (vertical) {
                [linkWidth, linkHeight] = [linkHeight, linkWidth];
                links.push([x, y, linkWidth, linkHeight, word]);
            } else {
                links.push([x, y, linkWidth, linkHeight, word]);
            }
        }

        function onMouseMove(ev) {
            var x, y;

            // Get the mouse position relative to the canvas element
            if (ev.layerX || ev.layerX === 0) { // For Firefox
                x = ev.layerX;
                y = ev.layerY;
            }

            // Link hover
            for (let i = 0; i < links.length; i++) {
                const link = links[i];
                const linkX = link[0],
                    linkY = link[1],
                    linkWidth = link[2],
                    linkHeight = link[3],
                    linkWord = link[4];

                // Check if cursor is in the link area
                if (linkX <= x && x <= (linkX + linkWidth) && linkY <= y && y <= (linkY + linkHeight)){
                    document.body.style.cursor = "pointer";
                    hoverWord = linkWord;
                    break;
                } else {
                    document.body.style.cursor = "";
                    hoverWord = "";
                }
            }
        }

        // Link click
        function onClick(e) {
            if (hoverWord) {
                papers_callback_word(hoverWord);
            }
        }
        for (let i = 0; i < words.length; i++) {
            const w = words[i];
            const word = w[0], x = w[1], y = w[2], size = w[3], vertical = w[4], color = w[5];
            // Add word with small shift, coordinates changed!
            addWord(word, y + 20, x + 20, size, vertical, color);
        }
    }

        $(document).ready(function() {
            $('#authors-table').DataTable();
            $('#journals-table').DataTable();

            var words = JSON.parse('{{ papers_word_cloud }}'.replace(/&#34;/g, '"').replace(/&amp;/g, '&'));
            process_word_cloud('papers_word_cloud', words);

            {% for (script, div), word_cloud, zoom_in_callback in subtopics_info_and_word_cloud_and_callback %}
                 words = JSON.parse('{{ word_cloud }}'.replace(/&#34;/g, '"').replace(/&amp;/g, '&'));
                 process_word_cloud('topic_word_cloud_{{ loop.index }}', words);
            {% endfor %}
        } );
    </script>
</head>
<body>

<!-- Fixed navbar -->
<nav class="navbar navbar-light bg-light justify-content-start fixed-top border-bottom">
    <span class="navbar-brand col-sm-3 col-md-2 col-xl-2 mr-0">
        <a id="pubtrends" class="navbar-brand" href="/">PubTrends</a>
    </span>
    <span class="search-string">
        {{ query }} at {{ source }}
    </span>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sticky sidebar -->
        <nav class="col-md-2 col-xl-2 d-none d-md-block bg-light sidebar border-bottom">
            <div class="sidebar-sticky">
                <ul class="nav flex-column mt-3">
                    <li class="nav-item">
                        <a class="nav-link" href="#overview">
                            <img src="{{ url_for('static', filename='home.svg') }}"/>&nbsp;Overview
                        </a>
                    </li>
                    {% if topics_analyzed %}
                    <li class="nav-item">
                        <a class="nav-link" href="#highlights">
                            <img src="{{ url_for('static', filename='bar-chart-2.svg') }}"/>&nbsp;Highlights
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#topics">
                            <img src="{{ url_for('static', filename='tag.svg') }}"/>&nbsp;Topics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#trends">
                            <img src="{{ url_for('static', filename='trending-up.svg') }}"/>&nbsp;Trends
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#publications">
                            <img src="{{ url_for('static', filename='columns.svg') }}"/>&nbsp;Publications
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="#authors">
                            <img src="{{ url_for('static', filename='users.svg') }}"/>&nbsp;Authors
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#journals">
                            <img src="{{ url_for('static', filename='book-open.svg') }}"/>&nbsp;Journals
                        </a>
                    </li>
                    {% if experimental %}
                    <li class="nav-item">
                        <a class="nav-link" href="#evolution">
                            <img src="{{ url_for('static', filename='flag.svg') }}"/>&nbsp;Experimental
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="#log">
                            <img src="{{ url_for('static', filename='align-justify.svg') }}"/>&nbsp;Log
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main content -->
        <main class="col-12 col-md-auto col-xl-10 justify-content-between" role="main">
            <div class="card mt-3">
                <div class="card-title" id="overview">
                    <h2 class="card-header">Overview</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <span class="stats-number"><b>{{ n_papers }}</b></span><br>
                                    <span class="card-text">papers</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <span class="stats-number"><b>{{ n_citations }}</b></span><br>
                                    <span class="card-text">citations</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <span class="stats-number"><b>{{ n_subtopics }}</b></span><br>
                                    <span class="card-text">subtopics</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-2">
                            <strong>Word cloud</strong>
                            <canvas id="papers_word_cloud" width="0" height="0" style="border:1px solid #eee;">
                                Canvas is not supported in your browser.
                            </canvas>
                        </div>
                        <div class="col-6">
                            {% for script, div in papers_stats %}
                            {{ script|safe }}
                            {{ div|safe }}
                            {% endfor %}
                        </div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-light"
                                onclick="(function(){ papers_callback() })();">
                            <img src="{{ url_for('static', filename='list.svg') }}"  alt="+"/>&nbsp;Show as list
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-title" id="highlights">
                    <h1 class="card-header">Highlights</h1>
                </div>
                <div class="card-body">
                    <h2 class="card-subtitle">Top Cited Papers Overall</h2>
                    <p>
                        Top 50 or 10% cited papers are shown among all the papers for given search query.<br>
                        Year reflects publication year of the original paper.
                    </p>
                    <div>
                        {% for script, div in top_cited_papers %}
                        {{ script|safe }}
                        {{ div|safe }}
                        {% endfor %}
                    </div>

                    <h2 class="card-subtitle">Top Cited Papers of the Year</h2>
                    <p>
                        For each year we show the paper which has the most significant number of citations in a given
                        year.<br>
                        Different papers have different colors.
                    </p>
                    <div>
                        {% for script, div in max_gain_papers %}
                        {{ script|safe }}
                        {{ div|safe }}
                        {% endfor %}
                    </div>

                    <h2 class="card-subtitle">Hot Papers</h2>
                    <p>
                        For each year we show a recent paper which has the biggest number of citation since the moment
                        of publication. <br>
                        Different papers have different colors.
                    </p>
                    <div>
                        {% for script, div in max_relative_gain_papers %}
                        {{ script|safe }}
                        {{ div|safe }}
                        {% endfor %}
                    </div>
                </div>
            </div>

            {% if topics_analyzed %}
            <div class="card mt-3">
                <div class="card-title" id="topics">
                    <h1 class="card-header">Topics</h1>
                </div>
                <div class="card-body">
                    <p> Citations graph is used to find all the papers which are cited together or <em>co-cited</em> by
                        other papers.<br>
                        Co-citations graph is used to extract subtopics using <em>Louvain</em> algorithm for community
                        detection.<br>
                        Click on bars to get detailed information about keywords and publications for each subtopic.
                        <br>
                        <em>Note: subtopics are merged to "Other" if they contain less than 5% of publications of the
                            field.</em>
                    </p>
                    <div>
                        {% for script, div in component_ratio %}
                        {{ script|safe }}
                        {{ div|safe }}
                        {% endfor %}
                    </div>


                    <a data-toggle="collapse" href="#collapseCocitations" role="button" aria-expanded="false"
                       aria-controls="collapseCocitations">
                        Show co-citations graph clustering details
                    </a>

                    <div class="collapse" id="collapseCocitations">
                        <p> {{clusters_info_message}} </p>
                        <div>
                            {% for script, div in cocitations_clusters %}
                            {{ script|safe }}
                            {{ div|safe }}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-title" id="trends">
                    <h1 class="card-header">Trends</h1>
                </div>
                <div class="card-body">
                    <h2 class="card-subtitle">Subtopics summary</h2>
                    <p>
                        Explore the evolution of trends - dynamics is shown for the timeline.<br>
                        Colors are the same as in the previous diagram.
                    </p>
                    <div>
                        {% for script, div in component_size_summary %}
                        {{ script|safe }}
                        {{ div|safe }}
                        {% endfor %}
                    </div>
                    <br>
                    <p>Each boxplot demonstrates summary publication year for given topic.</p>
                    <div>
                        {% for script, div in component_years_summary_boxplots %}
                        {{ script|safe }}
                        {{ div|safe }}
                        {% endfor %}
                    </div>

                </div>
            </div>

            <div class="card mt-3">
                <div class="card-title" id="publications">
                    <h1 class="card-header">Publications</h1>
                </div>
                <div class="card-body">
                    <p>
                        Learn more about subtopics - most cited papers over time are shown for each topic.<br>
                        Papers are sorted descending by citations number overall from bottom to top.<br>
                        Year reflects publication year of the original paper.
                    </p>
                    <div>
                        {% for (script, div), word_cloud, zoom_in_callback in subtopics_info_and_word_cloud_and_callback %}
                        <h2 id="subtopic-{{ loop.index }}" class="card-subtitle">
                            <hr>
                            Subtopic {{ loop.index }}
                            {% if loop.index0 == comp_other %}
                            - OTHER
                            {% endif %}
                            <button type="button" class="btn btn-light"
                                    onclick="(function(){ papers_callback_component({{ loop.index }}); })();">
                                <img src="{{ url_for('static', filename='list.svg') }}"  alt="+"/>&nbsp;Show as list
                            </button>
                            <button type="button" class="btn btn-light"
                                    onclick="(function(){ {{ zoom_in_callback|safe }} })();">
                                <img src="{{ url_for('static', filename='zoom-in.svg') }}"  alt="+"/>&nbsp;Zoom into
                            </button>
                        </h2>
                        Number of papers: {{ component_sizes[loop.index - 1] }}
                        <div class="row">
                            <div class="col-2">
                                <strong>Word cloud</strong>
                                <canvas id="topic_word_cloud_{{ loop.index }}" width="0" height="0" style="border:1px solid #eee;">
                                    Canvas is not supported in your browser.
                                </canvas>
                            </div>
                            <div class="col-6">
                                {{ script|safe }}
                                {{ div|safe }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <hr>
                    <p>
                        Explore related papers by taking into account all the referencing and citing relationships for papers of interest.<br>
                        <strong>WARNING</strong>: number of papers can increase exponentially, analysis can be slow!
                    </p>
                    <button type="button" class="btn btn-light"
                            onclick="(function(){ {{ papers_zoom_out_callback|safe }} })();">
                        <img src="{{ url_for('static', filename='zoom-out.svg') }}" alt="-"/>&nbsp;Zoom out to related papers
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="card mt-3">
                <div class="card-title" id="authors">
                    <h1 class="card-header">Authors</h1>
                </div>
                <div class="card-body">
                    <p>
                        List of authors with the largest number of papers for given search query.<br>
                        The colors of the circles in the subtopics column indicate top 3 most common subtopics among
                        these papers.<br>
                        The subtopic circles are arranged according to the number of papers, in descending order.
                    </p>
                    <table id="authors-table" class="table table-sm table-bordered table-striped">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Author</th>
                            <th scope="col">Papers</th>
                            <th scope="col">Subtopics</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in author_statistics %}
                        <tr>
                            <th scope="row">{{ loop.index }}</th>
                            <td>{{ row[0] }}</td>
                            <td><button type="button" class="btn btn-link" onclick="(function(){
                                papers_callback_author('{{ row[0] }}');
                            })();">{{ row[1] }}</button></td>
                            <td>{{ row[2]|safe }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-title" id="journals">
                    <h1 class="card-header">Journals</h1>
                </div>
                <div class="card-body">
                    <p>
                        List of journals with the largest number of papers for given search query.<br>
                        The colors of the circles in the subtopics column indicate top 3 most common subtopics among
                        these papers.<br>
                        The subtopic circles are arranged according to the number of papers, in descending order.
                    </p>
                    <table id="journals-table" class="table table-sm table-bordered table-striped">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Journal</th>
                            <th scope="col">Papers</th>
                            <th scope="col">Subtopics</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in journal_statistics %}
                        <tr>
                            <th scope="row">{{ loop.index }}</th>
                            <td>{{ row[0] }}</td>
                            <td><button type="button" class="btn btn-link" onclick="(function(){
                                papers_callback_journal('{{ row[0] }}');
                            })();">{{ row[1] }}</button></td>
                            <td>{{ row[2]|safe }}</td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% if experimental %}
            <div class="card mt-3">
                <div class="card-title" id="evolution">
                    <h1 class="card-header">Experimental</h1>
                </div>
                <div class="card-body">
                    <h2 class="card-subtitle">Subtopic Evolution</h2>
                    <p>
                        Topics extraction is performed longitudinally at several time points to detect merges and splits
                        of clusters,<br>
                        which can be related to new ideas. Clusters are described by several words with the highest<br>
                        <em>TF-IDF</em> value, edge width reflects the number of papers which moved from one cluster to
                        another.
                    </p>
                    <div>
                        {% if subtopic_evolution is defined %}
                        {% for script, div in subtopic_evolution %}
                        {{ script|safe }}
                        {{ div|safe }}
                        {% endfor %}
                        {% else %}
                        Failed to analyze subtopic evolution because year step is too big.
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="card mt-3">
                <div class="card-title" id="log">
                    <h1 class="card-header"><a data-toggle="collapse" href="#collapseLog" role="button" aria-expanded="false"
                                               aria-controls="collapseCocitations">
                        Log
                    </a></h1>
                </div>
                <div id="collapseLog" class="card-body collapse">
                    <pre>{{log}}</pre>
                </div>
            </div>
        </main>
    </div>
</div>
<footer>
    <p>version {{ version }}<br/>
        &copy;2019 <a href="https://research.jetbrains.org/groups/biolabs"
                      title="JetBrains Research BioLabs"
                      target="_blank">JetBrains Research</a></p>
</footer>
</body>
</html>